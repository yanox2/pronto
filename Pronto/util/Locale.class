<?php
/* Copyright 2013 dodat */
/*---------------------------------------------------------------------------*
 * Class
 *      言語設定
 *---------------------------------------------------------------------------*/
namespace PR;

class Locale{

	const TYPE_JA = 1;
	const TYPE_EN = 2;

	const SUFFIX_JA = 'ja';
	const SUFFIX_EN = 'en';

	private static $aPaths__ = array();
	private static $iLocale__ = 1;
	private static $iSysLocale__ = 1;
	private static $aMessages__ = array();
	private static $aSysMessages__ = array();

	public static function addIncPath($riLocale,$rsPath){
		self::$aPaths__[$riLocale] = $rsPath;
	}

	public static function getLocale(){
		return self::$iLocale__;
	}

	public static function setLocale($riLocale=0,$rbCookie=false,$rsPath=null){
		$locale = $riLocale;
		if($locale == 0){
			if(!isset($_COOKIE[C_PR_COOKIE_LOCALE])){
				$locale = self::getEnvLocale();
			}else{
				$locale = intval($_COOKIE[C_PR_COOKIE_LOCALE]);
			}
		}
		if(empty(self::$aMessages__)){
			self::__readLocaleFile($locale);
		}else if($locale != self::$iLocale__){
			self::__readLocaleFile($locale);
		}
		if($rbCookie){
			setcookie(C_PR_COOKIE_LOCALE,$locale,time()+30*24*3600,$rsPath);
		}
		self::$iLocale__ = $locale;
	}

	public static function getEnvLocale(){
		$langs = explode(',',$_SERVER['HTTP_ACCEPT_LANGUAGE']);
		$langs = array_reverse($langs);
		$result = self::TYPE_JA;
		foreach($langs as $lang){
			if(preg_match('/^ja/i',$lang)){
				$result = self::TYPE_JA;
			}else if(preg_match('/^en/i',$lang)){
				$result = self::TYPE_EN;
			}else if(preg_match('/^zh/i',$lang)){
				$result = self::TYPE_ZH;
			}
		}
		return $result;
	}

	public static function getMessage(){
		$msg = '';
		$argc = func_num_args();
		if($argc < 1){
			ELOG(SMSG('PR_E011','argc=0'));
			return $msg;
		}
		$args = func_get_args();
		$msgid = $args[0];
		if(!array_key_exists($msgid,self::$aMessages__)){
			ELOG(SMSG('PR_E002',$msgid));
			return $msg;
		}
		$format = self::$aMessages__[$msgid];
		if(count($args) == 1) return $format;

		array_shift($args);
		array_unshift($args,$format);
		$msg = call_user_func_array('sprintf',$args);

		if(self::$iLocale__ != self::TYPE_JA){
			$msg = str_replace('　',' ',$msg);
			$msg = str_replace('、',',',$msg);
		}
		return $msg;
	}

	public static function setSysLocale($riLocale){
		$suffix = self::SUFFIX_JA;
		if($riLocale == self::TYPE_EN) $suffix = self::SUFFIX_EN;
		$path = C_PR_SRCPATH.'/cmn/SysMessages_'.$suffix.'.inc';
		self::$aSysMessages__ = include($path);
		self::$iSysLocale__ = $riLocale;
	}

	public static function getSysMessage(){
		$msg = '';
		$argc = func_num_args();
		if($argc < 1){
			ELOG(SMSG('PR_E011','argc=0'));
			return $msg;
		}
		$args = func_get_args();
		$msgid = $args[0];
		if(!array_key_exists($msgid,self::$aSysMessages__)){
			ELOG(SMSG('PR_E002',$msgid));
			return $msg;
		}
		$format = self::$aSysMessages__[$msgid];
		if(count($args) == 1) return $format;

		array_shift($args);
		array_unshift($args,$format);
		$msg = call_user_func_array('sprintf',$args);

		if(self::$iLocale__ != self::TYPE_JA){
			$msg = str_replace('　',' ',$msg);
			$msg = str_replace('、',',',$msg);
		}
		return $msg;
	}

	private static function __readLocaleFile($riLocale){
		if(!array_key_exists($riLocale,self::$aPaths__)){
			ELOG(SMSG('PR_E003','loc='.$riLocale));
			return;
		}
		$path = self::$aPaths__[$riLocale];
		if(!is_readable($path)){
			ELOG(SMSG('PR_E003',$path));
			return;
		}
		self::$aMessages__ = include($path);
	}
}

function OMSG(){
	$args = func_get_args();
	$msg = call_user_func_array('\PR\Locale::getMessage',$args);
	return $msg;
}
function SMSG(){
	$args = func_get_args();
	$msg = call_user_func_array('\PR\Locale::getSysMessage',$args);
	return $msg;
}
?>
