<?php
/* Copyright 2013 dodat */
/*---------------------------------------------------------------------------*
 * Class - View
 *      ビュー基底クラス
 *---------------------------------------------------------------------------*/
namespace PR;

class View{

	private $oRenderer_ = null;
	private $aSuffixes_ = array();

	private $bFirstly_ = false;

	function __construct(){
		$this->oRenderer_ = new OnePane();
		$this->aSuffixes_[Request::PLATFORM_PC] = '';
		$this->aSuffixes_[Request::PLATFORM_TABLET] = 'Tb';
		$this->aSuffixes_[Request::PLATFORM_SPHONE] = 'Sp';
		$this->aSuffixes_[Request::PLATFORM_FPHONE] = 'Fp';
	}

/*---------------------------------------------------------------------------*
 * Public Methods
 *---------------------------------------------------------------------------*/
	public final function hasRenderer(){
		return !empty($this->oRenderer_);
	}

	public final function getRenderer(){
		return $this->oRenderer_;
	}

	public final function setRenderer($roRenderer){
		if(empty($roRenderer)){
			throw new Exception(C_PR_ERR_ENOENT,SMSG('PR_E011','roRenderer is null.'));
		}
		$this->oRenderer_ = $roRenderer;
		return 0;
	}

	public final function setRendererByName($rsClass){
		$renderer = new $rsClass();
		if(empty($renderer)){
			throw new Exception(C_PR_ERR_ENOENT,SMSG('PR_E011','rsClass is null.'));
		}
		$this->oRenderer_ = $renderer;
		return 0;
	}

	public function setRendererByPlatform($rsClass){
		$platform = Request::$iPLATFORM;
		$name = $rsClass.$this->aSuffixes_[$platform];
		$this->setRendererByName($name);
	}

	public function getValue($rsVar){
		return $this->oRenderer_->get($rsVar);
	}

	public function getAllValues(){
		return $this->oRenderer_->getAll();
	}

	public function setValue($rsVar,$raValue){
		$this->oRenderer_->set($rsVar,$raValue);
	}

	public function setTemplate($rsPath){
		if((empty($rsPath))||(!is_readable($rsPath))){
			throw new Exception(C_PR_ERR_ENOENT,SMSG('PR_E015',$rsPath));
		}
		$this->oRenderer_->setTemplate($rsPath);
	}

	public function setMessage($rsMessage,$riType){
		$this->oRenderer_->setMessage($rsMessage,$riType);
	}

	public function first(){
		$this->bFirstly_ = true;
	}

	public function show(){
		if(empty($this->oRenderer_)) $this->oRenderer_ = new OnePane();
		if($this->bFirstly_){
			$this->firstly();
		}else{
			$this->oRenderer_->render();
		}
	}

	public function firstly(){
		$path = SysEnv::getRoot().'/tpl/';
		$ren = $this->getRenderer();
		$ren->setTemplate($path.'firstly.tpl');
		$ren->render();
	}

	public function showError($roExp){
		$path = SysEnv::getRoot().'/tpl/';
		$code = $roExp->getCode();
		$message = $roExp->getMessage();

		if($code == C_PR_ERR_EACCESS){ // 403
			$this->oRenderer_->setTemplate($path.'403.tpl');
		}else if($code == C_PR_ERR_ENODEST){ // 404
			$this->oRenderer_->setTemplate($path.'404.tpl');
		}else if($code == C_PR_ERR_EINTERNAL){ // 500
			$this->oRenderer_->setTemplate($path.'500.tpl');
		}else if($code == C_PR_ERR_ETEMP){ // 503
			$this->oRenderer_->setTemplate($path.'503.tpl');
		}else if($roExp->isFatalError()){
			$this->oRenderer_->set('exp',$roExp);
			$this->oRenderer_->setTemplate($path.'fatal.tpl');
		}else if($this->hasRenderer()){
			$this->oRenderer_ = $this->getRenderer();
			if(!$this->oRenderer_->hasTemplate()){
				$this->oRenderer_->setTemplate($path.'error.tpl');
			}
			$this->oRenderer_->setMessage($message,Message::ERROR);
		}else{
			return;
		}
		$this->oRenderer_->render();
	}
}
?>
