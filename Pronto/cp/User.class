<?php
/* Copyright 2013 dodat */
/*---------------------------------------------------------------------------*
 * Class
 *      ユーザ基底クラス
 *---------------------------------------------------------------------------*/
namespace PR;

abstract class User{

	protected $oDao = null;
	protected $oMySubSys = null;
	protected $oMyProf = null;

	protected $oMail = null;
	protected $oMessage = null;

	protected $aPostProf = null;

	protected $aSesTargets_ = array('sLoginId','sPasswd');
	protected $aCkTargets_ = array('sLoginId','sPasswd');

	private $sSesPrefix_ = C_PR_PREFIX_SESSION;
	private $sCkPrefix_ = C_PR_PREFIX_COOKIE;

	public function __construct(){
		$this->oDao = \PR\DaoFactory::create();
		$this->oMail = new \PR\Mail();
		$this->oMessage = new \PR\Message();
	}

	public function setPrefixes($raPrefixes){
		$this->sSesPrefix_ = $raPrefixes['session'];
		$this->sCkPrefix_ = $raPrefixes['cookie'];
	}

	public function getSubSys(){
		return $this->oMySubSys;
	}
	public function getProf(){
		return $this->oMyProf;
	}
	public function setSubSys($roSubSystem){
		$this->oMySubSys = $roSubSystem;
	}
	public function setProf($roProfile){
		$this->oMyProf = $roProfile;
	}

	public function setSessionTargets($raTargets){
		$this->aSesTargets_ = $raTargets;
	}
	public function setCookieTargets($raTargets){
		$this->aCkTargets_ = $raTargets;
	}

/*---------------------------------------------------------------------------*
 * Reader
 *---------------------------------------------------------------------------*/
	public function numSubSys($raWhereTgs=null,$rsTokens=null){
		return $this->oMySubSys->numX($raWhereTgs,$rsTokens);
	}

	public function readSubSys($raWhereTgs=null,$rbHasLock=false){
		$sTokens = null;
		if($rbHasLock) $sTokens = 'for update';
		$rc = $this->oMySubSys->readX($raWhereTgs,$sTokens);
		return $rc;
	}

	public function numProf($raWhereTgs=null,$rsTokens=null){
		return $this->oMyProf->numX($raWhereTgs,$rsTokens);
	}

	public function readProf($raWhereTgs=null,$rbHasLock=false){
		$sTokens = null;
		if($rbHasLock) $sTokens = 'for update';
		$rc = $this->oMyProf->readX($raWhereTgs,$sTokens);
		if($rc != 0) return $rc;
		return 0;
	}

	public function pageProf($riPage,$riLimit,$raWhereTgs=null,$rsTokens=''){
		$rc = $this->numX($raWhereTgs,$sTokens);
		if($rc != 0) return $rc;
		$this->oPaging = new \PR\Paging($riPage,$riLimit,$rc);
		$tokens = $rsTokens.' '.$this->oPaging->getSql();
		return $this->oMyProf->listsX($raWheres,$tokens);
	}

	public function listsProf($raWhereTgs=null,$rsTokens=null,$raIndex=null){
		return $this->oMyProf->listsX($raWhereTgs,$rsTokens,$raIndex);
	}

/*---------------------------------------------------------------------------*
 * Post
 *---------------------------------------------------------------------------*/
	public function postProf(){
		$this->oMyProf->post();
		$rc = $this->oMyProf->checkPostByTarget();
		if(!empty($rc)) return $rc;
		return null;
	}

/*---------------------------------------------------------------------------*
 * Update
 *---------------------------------------------------------------------------*/
	public function addProf(){
		$rc = $this->oMyProf->addX();
		return $rc;
	}

	public function updateProf($raEncVars=null){
		$prof = $this->oMyProf->getEntity();
		if(!empty($raEncVars)){
			Misc::encode($prof,$raEncVars);
		}
		$rc = $this->oMyProf->updateX();
		if($rc != 0) return $rc;
		$this->setSession();
		$this->setCookie($prof->sLoginId,$post->sPasswd);
		return 0;
	}

/*---------------------------------------------------------------------------*
 * Message
 *---------------------------------------------------------------------------*/
	public function getMessage($riType=\PR\Message::NORMAL){
		$this->oMessage->load();
		return $this->oMessage->toString($riType);
	}

	public function setMessage($rsMessage,$riType=\PR\Message::NORMAL){
		$this->oMessage->add($rsMessage,$riType);
		$this->oMessage->save();
	}

	public function loadMessage(){
		$this->oMessage->load();
	}

	public function saveMessage(){
		$this->oMessage->save();
	}

/*---------------------------------------------------------------------------*
 * Session & Cookie
 *---------------------------------------------------------------------------*/
	public function startSession(){
		session_start();
	}

	public function fromSession(){
		$fx = $this->sSesPrefix_;
		$prof = $this->oMyProf->getEntity();
		if(empty($prof)) $prof = $this->oMyProf->newEntity();
		foreach($this->aSesTargets_ as $target){
			if(isset($_SESSION[$fx.$target])) $prof->{$target} = $_SESSION[$fx.$target];
		}
	}

	public function setSession(){
		$fx = $this->sSesPrefix_;
		$prof = $this->oMyProf->getEntity();
		if(empty($prof)) return;
		foreach($this->aSesTargets_ as $target){
			$_SESSION[$fx.$target] = $prof->{$target};
		}
	}

	public function clearSession(){
		$fx = $this->sSesPrefix_;
		foreach($this->aSesTargets_ as $target){
			unset($_SESSION[$fx.$target]);
		}
	}

	public function hasCookie($sTarget){
		return isset($_COOKIE[$this->sCkPrefix_.$sTarget]);
	}

	public function fromCookie(){
		$fx = $this->sCkPrefix_;
		$prof = $this->oMyProf->getEntity();
		if(empty($prof)) $prof = $this->oMyProf->newEntity();
		foreach($this->aCkTargets_ as $target){
			if(isset($_COOKIE[$fx.$target])) $prof->{$target} = $_COOKIE[$fx.$target];
		}
	}

	public function setCookie($rsPath=null,$rsDomain=null,$rbSecure=false,$rbHttpOnly=false){
		$fx = $this->sCkPrefix_;
		$time = time() + 30 * 24 * 3600;
		$prof = $this->oMyProf->getEntity();
		if(empty($prof)) return;
		foreach($this->aCkTargets_ as $target){
			setcookie($fx.$target,$prof->{$target},$time,$rsPath,$rsDomain,$rbSecure,$rbHttpOnly);
		}
	}

	public function removeCookie($rsPath=null,$rsDomain=null){
		$time = time() - 3600;
		foreach($this->aCkTargets_ as $target){
			setcookie($this->sCkPrefix_.$target,'',$time,$rsPath,$rsDomain);
		}
	}

	public function getAfterLogined(){
		return urldecode(Misc::getOneTimeSes('Redirect'));
	}
	public function setAfterLogined($rsUrl){
		Misc::setOneTimeSes('Redirect',urlencode($rsUrl));
	}

	public function isJustLogin(){
		return (Misc::getOneTimeSes('JustLogin') === true);
	}
	public function justLogin(){
		Misc::setOneTimeSes('JustLogin',true);
	}

/*---------------------------------------------------------------------------*
 * Login
 *---------------------------------------------------------------------------*/
	public function isLogin($rsTarget){
		return isset($_SESSION[$this->sSesPrefix_.$rsTarget]);
	}

	public function login($raTargets=null,$rbNoSubSys=false){
		if(!$rbNoSubSys){
			$this->oMySubSys->post();
			$rc = $this->oMySubSys->checkPostByTarget();
			if(!empty($rc)) return $rc;
			$rc = $this->readSubSys();
			if($rc != 0) return $rc;
		}
		$this->oMyProf->post();
		$rc = $this->oMyProf->checkPostByTarget();
		if(!empty($rc)){
			$this->setMessage($rc,\PR\Message::ERROR);
			return C_PR_ERR_EPARAM;
		}
		$this->aPostProf = $this->oMyProf->getArray();
		$this->oMyProf->mergeEntity($this->oMySubSys,true);
		$rc = $this->readProf($raTargets,true);
		if($rc != 0) return $rc;
		return 0;
	}

	public function logout(){
		$this->clearSession();
	}

	public function restore(){
		if(empty($this->aPostProf)) return;
		$this->oMyProf->setArray($this->aPostProf);
	}

	public function checkPassword($rsPassVal,$rsPassVar='sPasswd',$rsFailVar='iFailLogin',$riLimit=3){
		$prof = $this->oMyProf->getEntity();
		if(!Misc::hasProp($prof,$rsPassVar)) return C_PR_ERR_EPARAM;
		if(!Misc::hasProp($prof,$rsFailVar)) return C_PR_ERR_EPARAM;
		if($prof->{$rsFailVar} >= $riLimit) return C_PR_ERR_ELOCKED;
		if($rsPassVal == $prof->{$rsPassVar}) return 0;

		// パスワード誤り
		$prof->{$rsFailVar}++;
		$this->oMyProf->targetPrimary();
		$rc = $this->oMyProf->updateX(array($rsFailVar));
		if($rc != 0) return $rc;
		if($prof->{$rsFailVar} >= $riLimit) return C_PR_ERR_EOVER;
		return C_PR_ERR_EINVAL;
	}

/*---------------------------------------------------------------------------*
 * Mail
 *---------------------------------------------------------------------------*/
	public function sendMail($rsSubject,$rsBody,$rsNameVar='sName',$rsEMailVar='sEMail'){
		$prof = $this->oMyProf->getEntity();
		if(Misc::hasProp($prof,$rsNameVar)) return C_PR_ERR_EPARAM;
		if(Misc::hasProp($prof,$rsEMailVar)) return C_PR_ERR_EPARAM;
		$to = array($prof->{$rsEMailVar}=>$prof->{$rsNameVar});
		$rc = $this->oMail->send($to,$rsSubject,$rsBody);
		return $rc;
	}

/*---------------------------------------------------------------------------*
 * Protected Methods
 *---------------------------------------------------------------------------*/
	protected function errorOccured($riCode,$rsMsgId,$rsSection){
		$msg = OMSG($rsMsgId,$this->sMyName_.'.'.$rsSection);
		throw new Exception($riCode,$msg,true);
	}
}
?>
