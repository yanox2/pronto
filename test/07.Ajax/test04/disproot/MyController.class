<?php
/* Copyright 2016 dodat */
/*---------------------------------------------------------------------------*
 * Controller
 *      コントローラ
 *---------------------------------------------------------------------------*/

class MyController extends \PR\Controller{

	private $oDao_ = null;
	private $oUserProfile_ = null;

	// @Override 前処理
	protected function before(){
		$this->oDao_ = \PR\DaoFactory::create();
		$this->oDao_->connect();
		$this->oDao_->begin();
		$this->oUserProfile_ = new \sample\UserProfile();

		$view = $this->getView();
		$view->setRenderer(new MyRenderer());
		$uri = \PR\SysEnv::getYourDocRoot().'/07.Ajax/test04';
		$view->setValue('myURI',$uri);
	}

	// @Override 後処理
	protected function after(){
		$this->oDao_->commit();
		$this->oDao_->close();
	}

	// フォームの表示
	public function page(){
		$this->oUserProfile_->newEntity();
		$this->oUserProfile_->setArray(array('iSysId'=>35));
		$this->oUserProfile_->pageX();

		$path = \PR\SysEnv::getYourDispRoot().'/tpl/';
		$view = $this->getView();
		$view->setValue('UserProfile',$this->oUserProfile_);
		$ren = $view->getRenderer();
		$ren->setCenter($path.'center.tpl');

		$list = $this->oUserProfile_->getResults();
		$js = $this->_getJs($list);
		$ren->addScriptCode($js);
	}

	// フォームデータリクエスト
	public function request(){
		$this->ajax();
		$this->oUserProfile_->newEntity();
		$this->oUserProfile_->post();
		$this->oUserProfile_->setArray(array('iSysId'=>35));
		$this->oUserProfile_->readX();
		$this->oUserProfile_->targetAll();
		$items = $this->oUserProfile_->getArray(\PR\Model::TYPE_ALL,\PR\Container::POST);
		$res['dom']['replace'] = $items;
		$history = \PR\DaoMySQL::getSQLHistory();
		$sqlStr = '';
		if(!empty($history)){
			foreach($history as $sql){
				$sqlStr .= $sql."\n";
			}
		}
		$res['dom']['sql'] = $sqlStr;
		$this->resAjax(0,null,$res);
	}

	// 更新処理
	public function post(){
		$this->ajax();
		$this->oUserProfile_->newEntity();
		$this->oUserProfile_->post();
		$this->oUserProfile_->setArray(array('iSysId'=>35));
		$msg = $this->oUserProfile_->checkPostByTarget('<br>',6,0,2);
		if(!empty($msg)){
			$this->resAjax(-1,$msg);
			return;
		}
		$rc = $this->oUserProfile_->updateX();
		if($rc != 0){
			$this->resAjax($rc,'error occured !!');
			return;
		}

		// html更新
		$sqlStr = '';
		$history = \PR\DaoMySQL::getSQLHistory();
		if(!empty($history)){
			foreach($history as $sql){
				$sqlStr .= $sql.'<br>'."\n";
			}
		}
		$entity = $this->oUserProfile_->getEntity();
		$res = array('data'=>$this->oUserProfile_->getArray(\PR\Model::TYPE_ALL));
		if(!empty($sqlStr)) $res['sql'] = $sqlStr;
		$target = array('sLoginId','sName','sEMail','sNote');
		$items = $this->oUserProfile_->getArrayX($target,\PR\Container::VARIABLE,'div_'.$entity->iUserId.'_');
		$res['dom'] = array('replace'=>$items);
		$this->resAjax(0,'Success !!',$res);
	}

	private function _getJs($list){
		$js = ''
.'var Temp1 = {'."\n"
.'	active: function(){'."\n"
.'		$("#"+this.showId_).css({"opacity":1.0});'."\n"
.'	},'."\n"
.'	inactive: function(){'."\n"
.'		$("#"+this.showId_).css({"opacity":0.2});'."\n"
.'	}'."\n"
.'}'."\n"
.'var MyFormAjax = $.extend({},PRFormAjax,Temp1);'."\n"
.'var form = Object.create(MyFormAjax,{formId:"form_update",showId:"formDiv"});'."\n"
.''."\n"
.'var Temp2 = {'."\n"
.'	show: function(res){'."\n"
.'		if(this.dom) this._domUpdate(this.dom);'."\n"
.'		if((res)&&(res.dom)) this._domUpdate(res.dom);'."\n"
.'		var val = res.dom.replace["prReq_UserId"];'."\n"
.'		$("#prReq_UserId_d").html(val);'."\n"
.'		var val = res.dom.replace["prReq_State"];'."\n"
.'		$("#prReq_State_d").html(this._getStateStr(val));'."\n"
.'		if(res.dom.sql){'."\n"
.'			$("#disp_sql").html(pr_htmlspecialchars(res.dom.sql));'."\n"
.'		}'."\n"
.'	},'."\n"
.''."\n"
.'	_getStateStr: function(state){'."\n"
.'		var stats = ["","生存","死亡"];'."\n"
.'		return stats[state];'."\n"
.'	},'."\n"
.''."\n"
.'	after: function(res){'."\n"
.'		if(res.sql){'."\n"
.'			$("#disp_sql").html(pr_htmlspecialchars(res.sql));'."\n"
.'		}'."\n"
.''."\n"
.'		var tag = "<div>";'."\n"
.'		if(res.data){'."\n"
.'			$.each(res.data,function(id,val){'."\n"
.'				tag += id + "	" + val + "<br>";'."\n"
.'			 });'."\n"
.'		}'."\n"
.'		tag += "</div>";'."\n"
.'		$("#disp_entity").html(tag);'."\n"
.''."\n"
.'		if(res.dom){'."\n"
.'			var str = JSON.stringify(res.dom);'."\n"
.'			$("#disp_items").html(pr_htmlspecialchars(str));'."\n"
.'			this._domUpdate(res.dom);'."\n"
.'		}'."\n"
.''."\n"
.'		if((res.dom)&&(res.dom.prepend)){'."\n"
.'			var lis = Object.create(this,{actId:res.actId,reqId:res.reqId,hover:true});'."\n"
.'			form.addListener(lis);'."\n"
.'		}'."\n"
.'	}'."\n"
.'}'."\n"
.'var MyLis = $.extend({},PRFormAjaxListener,Temp2);'."\n"
.''."\n"
.'form.addSubmit("btn_update",0);'."\n"
.''."\n";
		foreach($list as $entity){
			$js .= 'lis = Object.create(MyLis,{actId:"div_'.$entity->iUserId.'_sLoginId",reqId:"req_'.$entity->iUserId.'",hover:true});'."\n";
			$js .= 'form.addListener(lis);'."\n";
		}
		$js .= 'form.listen();'."\n";
		return $js;
	}
}
?>
